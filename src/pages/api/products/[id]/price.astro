---
import { updateProductField, getProductById } from "../../../../lib/store";
import { formatCurrency } from "../../../../lib/format";
import { parseApiParams, getTableData } from "../../../../lib/api-utils";
import { createErrorResponse, createNotFoundResponse, validateNumericInput } from "../../../../lib/api-response-utils";
import { VALIDATION_RULES } from "../../../../lib/config";
import PriceCell from "../../../../components/PriceCell.astro";
import TotalsSummary from "../../../../components/TotalsSummary.astro";

const id = Number(Astro.params.id);
const formData = await Astro.request.formData();

const priceInput = formData.get("price");
const priceValidation = validateNumericInput(
  priceInput,
  "price",
  VALIDATION_RULES.MIN_PRICE,
  VALIDATION_RULES.MAX_PRICE
);

if (priceValidation instanceof Response) {
  return priceValidation;
}

const price = priceValidation;

if (price === VALIDATION_RULES.FORBIDDEN_PRICE) {
  return createErrorResponse(`Error: Price cannot be ${VALIDATION_RULES.FORBIDDEN_PRICE}`);
}

try {
  updateProductField(id, "price", price);
} catch (e) {
  return createErrorResponse("Error updating product");
}

// Get updated product and calculate new subtotal
const product = getProductById(id);
if (!product) {
  return createNotFoundResponse("Product");
}

const subtotal = product.price * product.quantity;

// Get updated totals for OOB swap
const params = parseApiParams(Astro.request);
const { totals } = getTableData(params);

// Set response headers for HTMX
Astro.response.headers.set("Content-Type", "text/html");
---

<!-- Main response: the updated price cell content -->
<PriceCell product={product} />

<!-- OOB swap for subtotal -->
<span
  class="view"
  id={`view-sub-${id}`}
  hx-swap-oob="outerHTML"
>
  {formatCurrency(subtotal)}
</span>

<!-- OOB swap for totals -->
<TotalsSummary totals={totals} />
