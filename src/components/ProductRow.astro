---
import { formatCurrency } from "../lib/format";
import PriceCell from "./PriceCell.astro";
import QuantityCell from "./QuantityCell.astro";
import type { Product } from "../types";
import { buildDeleteUrl } from "../lib/url-utils";
import { DEFAULT_PAGE, DEFAULT_PAGE_SIZE, DEFAULT_SORT_BY, DEFAULT_SORT_ORDER } from "../lib/constants";

export interface Props {
  product: Product;
  page?: number;
  pageSize?: number;
  sort?: string;
  sortDir?: string;
  searchTerm?: string;
}

const {
  product,
  page = DEFAULT_PAGE,
  pageSize = DEFAULT_PAGE_SIZE,
  sort = DEFAULT_SORT_BY,
  sortDir = DEFAULT_SORT_ORDER,
  searchTerm = "",
} = Astro.props;

// Build delete URL with current table state
const deleteUrl = buildDeleteUrl(product.id, {
  page: page !== DEFAULT_PAGE ? page : undefined,
  limit: pageSize !== DEFAULT_PAGE_SIZE ? pageSize : undefined,
  sortBy: sort !== DEFAULT_SORT_BY ? sort : undefined,
  sortOrder: sortDir !== DEFAULT_SORT_ORDER ? sortDir : undefined,
  searchTerm: searchTerm || undefined,
});

const subtotal = product.price * product.quantity;
---

<tr
  id={`row-${product.id}`}
  data-price={product.price}
  data-quantity={product.quantity}
>
  <td>{product.id}</td>
  <td class="w-[240px]">{product.name}</td>
  <td
    class="right w-[160px]"
    hx-ext="optimistic"
    id={`price-cell-${product.id}`}
  >
    <PriceCell product={product} />
  </td>
  <td
    class="right w-[160px]"
    hx-ext="optimistic"
    id={`qty-cell-${product.id}`}
  >
    <QuantityCell product={product} />
  </td>
  <td class="right">
    <span
      class="view"
      id={`view-sub-${product.id}`}
    >
      {formatCurrency(subtotal)}
    </span>
  </td>
  <td class="right">
    <button
      class="btn btn-error btn-sm"
      hx-delete={deleteUrl}
      hx-target="#table-wrapper"
      hx-swap="outerHTML swap:500ms"
      hx-select="#table-wrapper"
      hx-on:click="this.closest('tr').classList.add('fade-out')"
    >
      Delete
    </button>
  </td>
</tr>
